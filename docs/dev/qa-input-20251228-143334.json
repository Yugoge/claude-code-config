{
  "request_id": "dev-20251228-143334",
  "timestamp": "2025-12-28T14:33:34Z",
  "requirement": {
    "original": "现在修复clean，我发现了一个大问题，就是目前clean不检查一些非跨仓库通用的文件夹，比如仓库主目录的reports等，这导出现了很多被忽略的现象，比如非跨仓库通用文件夹中的非规范文件以及md文件等",
    "clarified": "Implement dynamic folder discovery and per-folder rule-based inspection system for /clean command. Create new rule-inspector subagent to analyze folder contents via Git history and generate INDEX.md + README.md rules documentation. Update existing inspectors to read and apply folder-specific rules instead of hardcoded checks.",
    "what": "Add rule-inspector subagent and make /clean inspect all folders dynamically with folder-specific rules",
    "why": "Current /clean hardcodes folder list (docs/, scripts/, tests/) and ignores project-specific folders (learning-materials/, skills_package/, etc.), missing non-compliant files in those folders",
    "where": [
      "agents/cleanliness-inspector.md - Remove hardcoded folder checks",
      "agents/rule-inspector.md - NEW: Create rule discovery agent",
      "commands/clean.md - Add initialization phase before inspection",
      "scripts/orchestrator.sh - Add rule-inspect command"
    ],
    "scope": {
      "included": [
        "Create rule-inspector subagent",
        "Implement Git history analysis for folder rules",
        "Generate INDEX.md and README.md for each folder",
        "Update cleanliness-inspector to read folder rules",
        "Update style-inspector to read folder rules",
        "Add initialization step to /clean command"
      ],
      "excluded": [
        "Changing existing folder structures",
        "Modifying file contents (only documentation)",
        "Automatic cleanup without user approval"
      ]
    },
    "success_criteria": [
      "rule-inspector subagent created with Git analysis capability",
      "INDEX.md and README.md generated for all project folders",
      "Inspectors discover folders dynamically (no hardcoding)",
      "Inspectors read and apply folder-specific rules from INDEX.md/README.md",
      "All folders (including learning-materials/, skills_package/) are checked",
      "All files comply with their folder's documented rules"
    ],
    "constraints": [
      "No hardcoded folder lists anywhere",
      "Rules must be derived from Git history and actual usage patterns",
      "Backward compatible with existing /clean workflow",
      "Initialization step must be optional (can skip if rules exist)"
    ]
  },
  "root_cause_analysis": {
    "symptom": "Project-specific folders like learning-materials/, skills_package/ are ignored by /clean command",
    "root_cause": "cleanliness-inspector.md hardcodes folder list in parameters (docs/, scripts/, tests/) and detection logic",
    "root_cause_locations": [
      "agents/cleanliness-inspector.md:45-48 - Hardcoded parameters",
      "agents/cleanliness-inspector.md:62-63 - Hardcoded docs/ rules",
      "agents/cleanliness-inspector.md:451-455 - Hardcoded folder iteration"
    ],
    "why_introduced": "Original design assumed all projects follow standard structure (docs/, scripts/, tests/)",
    "why_problematic": "Real projects have custom folders (learning-materials/, examples/, templates/, skills_package/) with their own organization needs",
    "timeline": "Existed since initial /clean implementation",
    "affected_files": [
      "agents/cleanliness-inspector.md",
      "agents/style-inspector.md",
      "commands/clean.md"
    ]
  },
  "context": {
    "codebase_state": {
      "git_status": "On branch master, nothing to commit, working tree clean",
      "current_branch": "master",
      "recent_commits": [
        "26fcef75 chore: update cleanliness-inspector agent",
        "0ac96426 feat: complete Office Skills setup with LICENSE files and test guide",
        "8dffd54b feat: clean repository without venv - fresh start"
      ]
    },
    "current_project_folders": [
      "agents/",
      "bin/",
      "commands/",
      "debug/",
      "docs/",
      "examples/",
      "hooks/",
      "learning-materials/",
      "logs/",
      "plugins/",
      "projects/",
      "scripts/",
      "session-env/",
      "shell-snapshots/",
      "skills_package/",
      "statsig/",
      "systemd/",
      "templates/",
      "tests/",
      "todos/"
    ],
    "ignored_folders_examples": [
      "learning-materials/ - Contains 2 MD files, not checked by /clean",
      "skills_package/ - Contains ~18 MD documentation files, not checked",
      "examples/ - May have example scripts, not validated",
      "templates/ - May have template files, not validated"
    ],
    "file_contents": {
      "agents/cleanliness-inspector.md": "Contains hardcoded folder checks at lines 45-48, 62-63, 451-455",
      "commands/clean.md": "Orchestrates inspection workflow, needs initialization step added"
    },
    "dependencies": {
      "runtime": "Bash 5.x, Git 2.x",
      "packages": "jq for JSON processing"
    },
    "environment": {
      "project_root": "/root/.claude",
      "config_files": [
        "commands/clean.md",
        "agents/cleanliness-inspector.md",
        "agents/style-inspector.md"
      ]
    }
  },
  "development_approach": {
    "strategy": "Two-phase approach: 1) Create rule-inspector to analyze and document folder rules, 2) Update inspectors to use those rules dynamically",
    "phase_1_initialization": {
      "description": "Rule discovery and documentation phase",
      "tasks": [
        "Create agents/rule-inspector.md subagent",
        "Implement Git history analysis for each folder",
        "Extract creation patterns from git log (which commands/subagents/scripts created files)",
        "Generate INDEX.md (folder inventory and organization)",
        "Generate README.md (folder purpose, rules, naming conventions)",
        "Store rules in standardized format for inspector consumption"
      ]
    },
    "phase_2_inspection": {
      "description": "Dynamic folder discovery and rule-based checking",
      "tasks": [
        "Update cleanliness-inspector to discover folders dynamically",
        "Read INDEX.md and README.md from each folder",
        "Apply folder-specific rules instead of hardcoded checks",
        "Update style-inspector similarly",
        "Remove all hardcoded folder references"
      ]
    },
    "scripts_to_create": [
      "scripts/discover-folders.sh - Dynamic folder discovery (excluding .git, venv, etc)",
      "scripts/analyze-folder-history.sh - Git history analysis for folder",
      "scripts/generate-folder-index.sh - Generate INDEX.md from folder contents",
      "scripts/generate-folder-readme.sh - Generate README.md from Git analysis"
    ],
    "files_to_create": [
      "agents/rule-inspector.md - New subagent for rule discovery"
    ],
    "files_to_modify": [
      "commands/clean.md - Add Step 3.5: Rule Initialization (before inspection)",
      "agents/cleanliness-inspector.md - Remove hardcoding, add dynamic folder discovery",
      "agents/style-inspector.md - Remove hardcoding, add dynamic folder discovery",
      "scripts/orchestrator.sh - Add rule-inspect command handler"
    ],
    "validation_approach": "QA will verify: 1) All folders have INDEX.md + README.md, 2) No hardcoded folder lists remain, 3) Inspectors check all folders including learning-materials/, skills_package/"
  },
  "standards_to_enforce": {
    "no_hardcoded_values": true,
    "use_source_venv": false,
    "integer_step_numbering": true,
    "meaningful_naming": true,
    "git_root_cause_reference": true,
    "parameterized_scripts": true
  },
  "dev": {
    "status": "completed",
    "tasks_completed": [
      {
        "id": 1,
        "description": "Created agents/rule-inspector.md subagent for folder rule discovery",
        "type": "agent",
        "files_created": [
          "/root/.claude/agents/rule-inspector.md"
        ],
        "rationale": "Root cause: cleanliness-inspector.md hardcodes folder list (docs/, scripts/, tests/). Solution: Create rule-inspector to analyze Git history and generate per-folder rules documentation (INDEX.md + README.md)"
      },
      {
        "id": 2,
        "description": "Created scripts/discover-folders.sh for dynamic folder discovery",
        "type": "script",
        "files_created": [
          "/root/.claude/scripts/discover-folders.sh"
        ],
        "rationale": "Replaces hardcoded folder lists with dynamic discovery excluding system directories (.git, venv, node_modules, etc.)"
      },
      {
        "id": 3,
        "description": "Created scripts/analyze-folder-history.sh for Git history analysis",
        "type": "script",
        "files_created": [
          "/root/.claude/scripts/analyze-folder-history.sh"
        ],
        "rationale": "Placeholder script for folder history analysis. Actual analysis performed by rule-inspector subagent with access to Git analysis tools"
      },
      {
        "id": 4,
        "description": "Created scripts/generate-folder-index.sh to generate INDEX.md",
        "type": "script",
        "files_created": [
          "/root/.claude/scripts/generate-folder-index.sh"
        ],
        "rationale": "Generates inventory of folder contents (INDEX.md) automatically from actual folder structure"
      },
      {
        "id": 5,
        "description": "Created scripts/generate-folder-readme.sh to generate README.md",
        "type": "script",
        "files_created": [
          "/root/.claude/scripts/generate-folder-readme.sh"
        ],
        "rationale": "Generates folder purpose and organization rules documentation (README.md) from Git analysis and file patterns"
      },
      {
        "id": 6,
        "description": "Updated commands/clean.md to add Step 3.5 for rule initialization",
        "type": "config",
        "files_modified": [
          "/root/.claude/commands/clean.md"
        ],
        "changes": "Added Step 3.5 between Step 3 and Step 4 to invoke rule-inspector before inspection phase. Made it optional (skip if INDEX.md/README.md already exist)",
        "rationale": "Root cause: /clean assumes all projects have standard structure. Fix: Initialize folder-specific rules before inspection to support custom project structures"
      },
      {
        "id": 7,
        "description": "Updated agents/cleanliness-inspector.md to remove hardcoded folders",
        "type": "agent",
        "files_modified": [
          "/root/.claude/agents/cleanliness-inspector.md"
        ],
        "changes": "Removed hardcoded parameters (docs_directory, scripts_directory, tests_directory) at lines 45-48. Added Step 0 for dynamic folder discovery. Updated historical docs detection (lines 451-455) to use discovered folders instead of hardcoded docs/ iteration. Changed to read INDEX.md and README.md from each folder for folder-specific rules",
        "rationale": "Root cause locations: lines 45-48 (hardcoded parameters), 62-63 (hardcoded docs/ rules), 451-455 (hardcoded folder iteration). Fix: Use scripts/discover-folders.sh and read rules from folder README.md files"
      },
      {
        "id": 8,
        "description": "Updated agents/style-inspector.md to remove hardcoded folders",
        "type": "agent",
        "files_modified": [
          "/root/.claude/agents/style-inspector.md"
        ],
        "changes": "Removed hardcoded files_to_audit array. Added Step 0 for dynamic folder discovery and file audit scope determination based on discovered folders",
        "rationale": "Root cause: style-inspector assumes specific folder structure (.claude/commands, scripts/, tests/). Fix: Dynamically discover folders and determine audit scope"
      },
      {
        "id": 9,
        "description": "Updated scripts/orchestrator.sh to add rule-inspect command",
        "type": "script",
        "files_modified": [
          "/root/.claude/scripts/orchestrator.sh"
        ],
        "changes": "Added rule-inspect mode to MODE validation. Added rule_inspect() function to coordinate rule-inspector subagent. Updated case statement to handle rule-inspect mode",
        "rationale": "Orchestrator needs to support invoking rule-inspector subagent for folder rule discovery phase"
      }
    ],
    "scripts_created": [
      {
        "path": "/root/.claude/scripts/discover-folders.sh",
        "purpose": "Dynamically discover project folders excluding system directories",
        "parameters": [
          "project_root"
        ],
        "usage": "discover-folders.sh /path/to/project",
        "exit_codes": {
          "0": "Success - folders discovered and output to stdout",
          "1": "Failure - project root not found or invalid"
        }
      },
      {
        "path": "/root/.claude/scripts/analyze-folder-history.sh",
        "purpose": "Analyze Git history for folder to discover file creation patterns",
        "parameters": [
          "folder_path"
        ],
        "usage": "analyze-folder-history.sh /path/to/folder",
        "exit_codes": {
          "0": "Success - JSON structure output",
          "1": "Failure - folder not found"
        }
      },
      {
        "path": "/root/.claude/scripts/generate-folder-index.sh",
        "purpose": "Generate INDEX.md for folder (inventory of contents)",
        "parameters": [
          "folder_path"
        ],
        "usage": "generate-folder-index.sh /path/to/folder",
        "exit_codes": {
          "0": "Success - INDEX.md generated",
          "1": "Failure - folder not found"
        }
      },
      {
        "path": "/root/.claude/scripts/generate-folder-readme.sh",
        "purpose": "Generate README.md for folder (purpose and organization rules)",
        "parameters": [
          "folder_path",
          "purpose",
          "allowed_types",
          "naming_convention"
        ],
        "usage": "generate-folder-readme.sh /path/to/folder 'Purpose description' '.md, .json' 'kebab-case'",
        "exit_codes": {
          "0": "Success - README.md generated",
          "1": "Failure - folder not found"
        }
      }
    ],
    "files_modified": [
      {
        "path": "/root/.claude/commands/clean.md",
        "changes": "Added Step 3.5 for optional rule initialization phase before cleanliness inspection"
      },
      {
        "path": "/root/.claude/agents/cleanliness-inspector.md",
        "changes": "Removed hardcoded folder parameters and iteration. Added dynamic folder discovery using discover-folders.sh. Added logic to read folder-specific rules from INDEX.md and README.md"
      },
      {
        "path": "/root/.claude/agents/style-inspector.md",
        "changes": "Removed hardcoded files_to_audit array. Added dynamic folder discovery and audit scope determination"
      },
      {
        "path": "/root/.claude/scripts/orchestrator.sh",
        "changes": "Added rule-inspect mode and rule_inspect() function to support rule-inspector subagent invocation"
      }
    ],
    "git_rationale": {
      "root_cause_commit": "Original /clean implementation with hardcoded folder assumptions",
      "why_issue_occurred": "Original design assumed all projects follow standard structure (docs/, scripts/, tests/). Real projects have custom folders (learning-materials/, skills_package/, examples/, templates/) with different organization needs",
      "how_fix_addresses_root": "Implements two-phase approach: 1) Rule Initialization - Analyzes Git history to discover how folders are actually used and generates INDEX.md + README.md documenting folder-specific rules. 2) Dynamic Inspection - Inspectors discover folders using discover-folders.sh and read rules from each folder's README.md instead of assuming hardcoded structure. This supports any folder structure while maintaining organization standards"
    },
    "qa_ready": true,
    "qa_notes": "Verify: 1) All scripts are executable and use parameters (no hardcoded values). 2) cleanliness-inspector.md and style-inspector.md no longer have hardcoded folder references at original violation locations (lines 45-48, 62-63, 451-455). 3) orchestrator.sh accepts rule-inspect mode. 4) commands/clean.md has Step 3.5 added between Step 3 and Step 4 using integer numbering. 5) All folders (including learning-materials/, skills_package/) will be discovered and inspected",
    "permissions_to_add": [
      {
        "section": "allow",
        "pattern": "Bash(scripts/discover-folders.sh:*)",
        "reason": "Allow execution of dynamic folder discovery script created by /dev"
      },
      {
        "section": "allow",
        "pattern": "Bash(scripts/analyze-folder-history.sh:*)",
        "reason": "Allow execution of folder history analysis script created by /dev"
      },
      {
        "section": "allow",
        "pattern": "Bash(scripts/generate-folder-index.sh:*)",
        "reason": "Allow execution of INDEX.md generation script created by /dev"
      },
      {
        "section": "allow",
        "pattern": "Bash(scripts/generate-folder-readme.sh:*)",
        "reason": "Allow execution of README.md generation script created by /dev"
      },
      {
        "section": "allow",
        "pattern": "Bash(~/.claude/scripts/orchestrator.sh rule-inspect:*)",
        "reason": "Allow orchestrator to invoke rule-inspector subagent"
      }
    ]
  }
}
