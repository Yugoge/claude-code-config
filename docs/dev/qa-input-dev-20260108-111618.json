{
  "request_id": "dev-20260108-111618",
  "timestamp": "2026-01-08T11:16:18Z",
  "requirement": {
    "original": "两个任务，第一个任务检查为什么这么多非功能文件夹和文档没有被删除？第二个添加一个readme-updator加入到clean工作流中专门负责更新所有的readme，以反映最新的仓库变化",
    "clarified": "Task 1: Fix /clean workflow - cleanliness-inspector is NOT detecting non-functional folders (.bmad-core, .cursor, bin, examples, learning-materials, logs, skills_package, systemd, templates, tests). Task 2: Fix rule-inspector to always update READMEs with recent changes instead of only initializing once",
    "what": "Fix two critical issues in /clean workflow: (1) Add non-functional folder detection to cleanliness-inspector, (2) Make rule-inspector update READMEs on every run with freshness detection",
    "why": "User has 11 non-functional folders (totaling ~6MB) that were never detected by /clean. READMEs are outdated because rule-inspector only runs conditionally and never overwrites.",
    "where": [
      "agents/cleanliness-inspector.md",
      "agents/rule-inspector.md",
      "commands/clean.md"
    ],
    "scope": {
      "included": [
        "Add Section 14 to cleanliness-inspector.md: Non-Functional Folders Detection",
        "Detect folders: .bmad-core, .cursor, bin, examples, learning-materials, logs, skills_package, systemd, templates, tests",
        "Modify rule-inspector to ALWAYS run (not conditionally)",
        "Add README freshness detection (check last_modified vs folder content changes)",
        "Add smart update modes: full-scan (>7 days old) vs incremental (recent commits)",
        "Fix 'Never Overwrite' rule to allow selective rewriting when outdated"
      ],
      "excluded": [
        "Changing cleaner execution logic",
        "Modifying style-inspector",
        "Creating new subagents (enhance existing ones)"
      ]
    },
    "success_criteria": [
      "cleanliness-inspector detects all 11 non-functional folders",
      "cleanliness-inspector reports recommend archiving or deleting these folders",
      "rule-inspector runs on EVERY /clean execution (not conditional)",
      "rule-inspector detects README staleness (>7 days without updates)",
      "rule-inspector updates READMEs with recent commits when stale",
      "test/ folder is correctly identified as functional (preserved)",
      "All folders lacking README get one generated",
      "Existing READMEs get updated with recent changes"
    ],
    "constraints": [
      "Must preserve functional folders: agents/, scripts/, hooks/, commands/, docs/, test/",
      "Must not break existing /clean workflow steps",
      "Must use venv activation pattern: source ~/.claude/venv/bin/activate && python3",
      "Must follow integer step numbering in documentation",
      "Must reference root cause commits in changes"
    ]
  },
  "root_cause_analysis": {
    "symptom": "User sees 11 non-functional folders not being cleaned by /clean command",
    "root_causes": [
      {
        "issue": "cleanliness-inspector missing non-functional folder detection",
        "root_cause_commit": "No specific commit - design gap from initial implementation",
        "evidence": "cleanliness-inspector.md Section 7 only detects individual non-functional FILES (*.log, *.tmp), not entire non-functional FOLDERS",
        "why_introduced": "Original design focused on file-level detection, not folder-level detection",
        "why_problematic": "Cannot detect orphaned folders like .bmad-core, .cursor, bin, examples, learning-materials, logs, skills_package, systemd, templates, tests",
        "affected_files": [
          "agents/cleanliness-inspector.md"
        ]
      },
      {
        "issue": "rule-inspector only runs conditionally",
        "root_cause_commit": "commands/clean.md lines 151-188 - conditional NEEDS_INIT check",
        "evidence": "if [[ \"$NEEDS_INIT\" == \"true\" ]]; then ... else echo \"✅ Folder rules already present, skipping initialization\"",
        "why_introduced": "Performance optimization - avoid regenerating READMEs if they exist",
        "why_problematic": "READMEs become stale as repository evolves, never get updated after initial creation",
        "affected_files": [
          "commands/clean.md",
          "agents/rule-inspector.md"
        ]
      },
      {
        "issue": "rule-inspector 'Never Overwrite' rule too conservative",
        "root_cause_commit": "agents/rule-inspector.md lines 252-256",
        "evidence": "### Never Overwrite - If INDEX.md or README.md already exist, read them first - Preserve any manual additions or customizations - Append auto-generated sections only",
        "why_introduced": "Safety measure to preserve manual edits",
        "why_problematic": "Cannot refresh outdated content, only appends, READMEs accumulate stale information",
        "affected_files": [
          "agents/rule-inspector.md"
        ]
      },
      {
        "issue": "No README freshness detection mechanism",
        "root_cause_commit": "agents/rule-inspector.md - missing feature",
        "evidence": "No logic to compare README last_modified timestamp vs folder content changes",
        "why_introduced": "Feature never designed",
        "why_problematic": "Cannot detect when README is outdated (e.g., 30+ days old while folder has recent commits)",
        "affected_files": [
          "agents/rule-inspector.md"
        ]
      },
      {
        "issue": "Git analysis depth insufficient for recent changes",
        "root_cause_commit": "agents/rule-inspector.md lines 258-262",
        "evidence": "Analyze at least last 6 months of history",
        "why_introduced": "Reasonable default for historical analysis",
        "why_problematic": "Recent changes (last 3-7 days) have same weight as 6-month-old changes, no recency bias",
        "affected_files": [
          "agents/rule-inspector.md"
        ]
      }
    ],
    "timeline": "Issues present since initial /clean workflow design (December 2025)",
    "affected_folders": [
      ".bmad-core (75 files, 808K) - external tool config, should archive",
      ".cursor (10 files, 92K) - Cursor editor config, should archive",
      "bin (1 file, 8K) - single quick-excel script, should merge into scripts/",
      "examples (1 file, 8K) - settings example, should move to docs/examples/",
      "learning-materials (1 file, 16K) - guide doc, should move to docs/guides/",
      "logs (18 files, 4.8MB) - runtime logs, should add to .gitignore and delete",
      "skills_package (18 files, 252K) - legacy skills, already in .claude/skills/, should archive",
      "systemd (1 file, 8K) - service file, should move to docs/reference/",
      "templates (1 file, 8K) - settings template, should move to docs/templates/",
      "tests (2 files, 24K) - duplicate of test/, should merge into test/",
      "test (27 files, 252K) - FUNCTIONAL FOLDER, must preserve"
    ]
  },
  "context": {
    "codebase_state": "On branch master, working tree clean",
    "recent_commits": [
      "15a2975f fix: achieve 100% validator pass rate by fixing EC002 documentation",
      "c807ebc3 fix: translate remaining hooks files to complete EC006 compliance"
    ],
    "file_contents": {
      "agents/cleanliness-inspector.md": "Has 13 detection sections (0-8, orphaned_subagents, orphaned_tests, unreferenced_scripts, obsolete_functionality). Missing: non-functional folder detection",
      "agents/rule-inspector.md": "Generates INDEX.md and README.md based on Git history. Has 'Never Overwrite' safety rule. No freshness detection.",
      "commands/clean.md": "Step 4 conditionally calls rule-inspector only if NEEDS_INIT==true (missing INDEX.md or README.md)"
    },
    "dependencies": {
      "runtime": "Python 3.12, Bash 5.x",
      "packages": "jq for JSON manipulation"
    },
    "environment": {
      "venv_path": "~/.claude/venv",
      "config_files": [
        "settings.json",
        "CLAUDE.md"
      ]
    }
  },
  "development_approach": {
    "strategy": "Fix root causes systematically: (1) Add non-functional folder detection logic to cleanliness-inspector, (2) Make rule-inspector always run with freshness detection, (3) Add smart update modes",
    "phase_1": {
      "name": "Enhance cleanliness-inspector.md",
      "tasks": [
        "Add new Section 14: Non-Functional Folders Detection",
        "Define detection logic: check for folders without README.md AND no references in commands/agents/scripts",
        "Add hidden folder scanning (.bmad-core, .cursor)",
        "Add orphaned folder detection (folders with <5 files and no clear purpose)",
        "Add logs folder special handling (runtime data, not committed)",
        "Add duplicate folder detection (test vs tests)",
        "Report structure: non_functional_folders array with recommendations (archive/delete/merge)"
      ]
    },
    "phase_2": {
      "name": "Enhance rule-inspector.md",
      "tasks": [
        "Add Section: README Freshness Detection",
        "Logic: Compare README mtime vs max(folder files mtime)",
        "Add threshold: if diff > 7 days, trigger full update",
        "Add incremental update mode: if fresh (<3 days), append recent commits only",
        "Modify 'Never Overwrite' to 'Smart Overwrite': preserve manual sections, rewrite auto-generated sections",
        "Add recency weighting: recent commits (0-7 days) weighted 3x higher in README",
        "Add Git analysis enhancement: analyze last 30 days commits separately from 6-month history"
      ]
    },
    "phase_3": {
      "name": "Modify commands/clean.md Step 4",
      "tasks": [
        "Change conditional logic: ALWAYS run rule-inspector",
        "Remove 'if NEEDS_INIT==true' check",
        "Pass freshness_check parameter to rule-inspector",
        "Update verification checkpoint: check READMEs updated, not just created"
      ]
    },
    "scripts_to_create": [],
    "files_to_modify": [
      "agents/cleanliness-inspector.md",
      "agents/rule-inspector.md",
      "commands/clean.md"
    ],
    "validation_approach": "Run /clean and verify: (1) cleanliness report detects 11 non-functional folders, (2) rule-inspector updates all READMEs, (3) READMEs show recent commits"
  },
  "standards_to_enforce": {
    "no_hardcoded_values": true,
    "use_source_venv": true,
    "integer_step_numbering": true,
    "meaningful_naming": true,
    "git_root_cause_reference": true
  },
  "dev": {
    "status": "completed",
    "tasks_completed": [
      {
        "id": 1,
        "description": "Added Section 14: Non-Functional Folders Detection to cleanliness-inspector.md",
        "type": "enhancement",
        "files_modified": [
          "/root/.claude/agents/cleanliness-inspector.md"
        ],
        "changes": "Added comprehensive folder-level detection with 5 detection categories: (1) Folders without documentation AND no references, (2) Hidden folders detection (.bmad-core, .cursor), (3) Orphaned folders (<5 files, no clear purpose), (4) Logs folder special handling (runtime data), (5) Duplicate folder detection (test vs tests)",
        "rationale": "Root cause: cleanliness-inspector.md originally designed for file-level detection only (Section 7: Non-Functional Files). Missing folder-level detection meant entire non-functional folders (.bmad-core, .cursor, bin, examples, learning-materials, logs, skills_package, systemd, templates, tests) were never detected by /clean workflow.",
        "lines_added": 319,
        "detection_categories": [
          "orphaned_single_file: Folders with 1-3 files, no README, no references (e.g., bin/)",
          "orphaned_tool_config: Hidden folders for external tools not in use (e.g., .bmad-core/)",
          "orphaned_editor_config: Editor-specific configs not recently used (e.g., .cursor/)",
          "runtime_data_not_ignored: Runtime logs/cache not in .gitignore (e.g., logs/)",
          "orphaned_content: Content in wrong location (e.g., examples/ should be docs/examples/)",
          "duplicate_legacy: Legacy duplicate of active folder (e.g., skills_package/ vs .claude/skills/)",
          "duplicate_folder: Naming duplicates (e.g., test/ vs tests/)"
        ],
        "report_structure": "Added non_functional_folders array to JSON output with fields: folder, type, reason, file_count, folder_size, recommendation, archive_to/merge_target/relocate_to, rationale, severity"
      },
      {
        "id": 2,
        "description": "Added README Freshness Detection to rule-inspector.md (new Step 7)",
        "type": "enhancement",
        "files_modified": [
          "/root/.claude/agents/rule-inspector.md"
        ],
        "changes": "Added Step 7: Check README Freshness before Step 8: Generate README.md. Compares README mtime vs max(folder files mtime). Thresholds: >7 days = full update, 3-7 days = incremental, <3 days = skip. Added recency weighting for Git analysis: 0-7 days commits weighted 3x, 8-30 days weighted 2x, 31-180 days weighted 1x.",
        "rationale": "Root cause: agents/rule-inspector.md missing freshness detection feature. No logic to detect when README.md is outdated compared to actual folder changes. READMEs could be 30+ days old while folder has recent commits, but rule-inspector had no way to detect staleness.",
        "lines_added": 105,
        "update_modes": {
          "create": "README doesn't exist, generate from scratch",
          "full": "README >7 days older than folder content, regenerate with full Git analysis",
          "incremental": "README 3-7 days old, append recent changes section only",
          "skip": "README fresh (<3 days difference), no update needed"
        },
        "recency_weighting": {
          "0-7_days": "3x weight",
          "8-30_days": "2x weight",
          "31-180_days": "1x weight"
        }
      },
      {
        "id": 3,
        "description": "Changed 'Never Overwrite' rule to 'Smart Overwrite' in rule-inspector.md",
        "type": "modification",
        "files_modified": [
          "/root/.claude/agents/rule-inspector.md"
        ],
        "changes": "Replaced 'Never Overwrite' safety rule with 'Smart Overwrite'. Added detection logic to distinguish auto-generated READMEs (with marker) from manual READMEs. Auto-generated READMEs can be fully rewritten when stale. Manual READMEs only have auto-generated sections updated (Git Analysis, Recent Changes). INDEX.md always regenerated (pure inventory).",
        "rationale": "Root cause: agents/rule-inspector.md lines 252-256 'Never Overwrite' rule too conservative. Could only append, never refresh outdated content. READMEs accumulated stale information because rule-inspector couldn't selectively rewrite auto-generated sections.",
        "old_behavior": "Never overwrite existing README/INDEX, only append auto-generated sections",
        "new_behavior": "Auto-generated READMEs: full rewrite when stale. Manual READMEs: preserve manual sections, update only marked auto-generated sections (<!-- AUTO-GENERATED by rule-inspector -->)",
        "overwrite_rules": {
          "auto_generated_readmes": "If stale (>7 days): Full rewrite. If moderate (3-7 days): Incremental. If fresh (<3 days): Skip",
          "manual_readmes": "NEVER overwrite entire file. Update only marked sections: Git Analysis, Recent Changes, File Types (if changed)",
          "index_md": "Always regenerate (it's a pure inventory, update timestamp each time)"
        }
      },
      {
        "id": 4,
        "description": "Modified commands/clean.md Step 4 to always run rule-inspector",
        "type": "modification",
        "files_modified": [
          "/root/.claude/commands/clean.md"
        ],
        "changes": "Removed conditional NEEDS_INIT check. Changed from 'Rule Initialization' to 'Rule Inspection and README Updates'. Now ALWAYS runs rule-inspector on EVERY /clean execution. Passes freshness_check parameter. Updated verification checkpoint from 'check READMEs created' to 'check READMEs updated or confirmed fresh'.",
        "rationale": "Root cause: commands/clean.md lines 151-188 conditional execution logic. Rule-inspector only ran if NEEDS_INIT==true (missing INDEX.md or README.md). Once folders had READMEs, rule-inspector never ran again, causing READMEs to become stale as repository evolved.",
        "old_behavior": "if NEEDS_INIT==true (missing README/INDEX): run rule-inspector. else: skip with message 'Folder rules already present, skipping initialization'",
        "new_behavior": "ALWAYS run rule-inspector with freshness_check=true. Updates stale READMEs, creates missing ones, regenerates INDEX.md. Step renamed to emphasize it's inspection, not just initialization.",
        "parameters_added": {
          "freshness_check": true,
          "update_stale_readmes": true
        },
        "verification_change": "Before: 'Rule initialization completed OR not needed'. After: 'Rule inspection completed AND READMEs updated or confirmed fresh'"
      }
    ],
    "scripts_created": [],
    "git_rationale": {
      "cleanliness_inspector_enhancement": {
        "root_cause_commit": "No specific commit - design gap from initial implementation (December 2025)",
        "evidence": "cleanliness-inspector.md Section 7 only detects individual non-functional FILES (*.log, *.tmp), not entire non-functional FOLDERS",
        "why_issue_occurred": "Original design focused on file-level detection patterns (temp files, build artifacts). Folder-level detection was not considered in initial implementation.",
        "how_fix_addresses_root": "Added Section 14 with 5 comprehensive folder detection algorithms covering all non-functional folder types: hidden configs, orphaned folders, runtime data, duplicates, misplaced content. Now detects all 11 non-functional folders user reported."
      },
      "rule_inspector_freshness": {
        "root_cause_commit": "agents/rule-inspector.md - missing feature (never designed)",
        "evidence": "No logic exists to compare README last_modified timestamp vs folder content changes",
        "why_issue_occurred": "Rule-inspector designed for one-time initialization, not ongoing maintenance. Freshness detection feature never implemented.",
        "how_fix_addresses_root": "Added Step 7 freshness check comparing README mtime vs max(folder files mtime). Determines update mode (full/incremental/skip) based on staleness. Prevents READMEs from becoming outdated."
      },
      "rule_inspector_smart_overwrite": {
        "root_cause_commit": "agents/rule-inspector.md lines 252-256",
        "evidence": "### Never Overwrite - If INDEX.md or README.md already exist, read them first - Preserve any manual additions or customizations - Append auto-generated sections only",
        "why_issue_occurred": "Safety measure to preserve manual edits was too conservative. Could never refresh outdated auto-generated content.",
        "how_fix_addresses_root": "Changed to Smart Overwrite with section markers. Auto-generated READMEs (with marker) can be rewritten when stale. Manual READMEs have only marked sections updated (<!-- AUTO-GENERATED -->). Balances safety with freshness."
      },
      "clean_command_conditional_execution": {
        "root_cause_commit": "commands/clean.md lines 151-188 - conditional NEEDS_INIT check",
        "evidence": "if [[ \"$NEEDS_INIT\" == \"true\" ]]; then ... else echo \"✅ Folder rules already present, skipping initialization\"",
        "why_issue_occurred": "Performance optimization to avoid regenerating READMEs if they exist. Assumed READMEs would stay fresh.",
        "how_fix_addresses_root": "Removed conditional. Rule-inspector now runs EVERY time with freshness_check parameter. Only updates when needed (stale detection), but always checks. Ensures READMEs reflect latest repository state."
      },
      "git_analysis_recency_weighting": {
        "root_cause_commit": "agents/rule-inspector.md lines 258-262",
        "evidence": "Analyze at least last 6 months of history",
        "why_issue_occurred": "All commits in 6-month window had equal weight. Recent changes (last 3-7 days) had same influence as 6-month-old changes.",
        "how_fix_addresses_root": "Added recency weighting: 0-7 days = 3x, 8-30 days = 2x, 31-180 days = 1x. Separated last 30 days analysis. READMEs now emphasize recent patterns and changes."
      }
    },
    "qa_ready": true,
    "qa_notes": "Test /clean workflow: (1) Verify cleanliness report includes non_functional_folders array with 11 folders detected, (2) Verify rule-inspector runs on every execution (not conditional), (3) Verify READMEs get freshness check and update when stale, (4) Verify Smart Overwrite preserves manual sections while updating auto-generated ones, (5) Verify recency weighting applied (recent commits weighted higher)",
    "permissions_to_add": []
  }
}
