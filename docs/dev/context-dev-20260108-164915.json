{
  "request_id": "dev-20260108-164500",
  "timestamp": "2026-01-08T16:45:00Z",
  "requirement": {
    "original": "不对，WORKFLOW_ORCHESTRATED_AGENTS 这样就hardcoded了，应该修改检查command引用subagent的逻辑才对",
    "clarified": "Fix cleanliness-inspector's orphan detection logic to be more intelligent - detect agent references in Step descriptions, Task tool invocations, and orchestrator.sh calls, not just subagent_type patterns",
    "what": "Improve orphan detection logic in cleanliness-inspector.md to handle dynamically-orchestrated agents",
    "why": "Current logic only searches for 'subagent_type' patterns, missing agents invoked via Task tool descriptions, Step narratives, or orchestrator.sh scripts",
    "where": ["agents/cleanliness-inspector.md lines 318-364"],
    "scope": {
      "included": [
        "Enhance grep patterns to detect agent references in multiple contexts",
        "Add detection for Task tool invocations (grep for 'Task.*agents/X.md')",
        "Add detection for Step descriptions mentioning agent invocation",
        "Add detection for orchestrator.sh script calls",
        "Restore git-edge-case-analyst.md to agents/",
        "Integrate git-edge-case-analyst into /test command"
      ],
      "excluded": [
        "Adding hardcoded exception lists",
        "Creating WORKFLOW_ORCHESTRATED_AGENTS array",
        "Any other hardcoded agent names"
      ]
    },
    "success_criteria": [
      "Orphan detection logic checks 4+ different reference patterns",
      "git-edge-case-analyst.md restored to agents/ directory",
      "/test command explicitly references git-edge-case-analyst in Step 1",
      "Detection logic will catch git-edge-case-analyst reference in /test",
      "No hardcoded agent names in detection logic"
    ],
    "constraints": [
      "Must not use hardcoded exception lists",
      "Detection logic must be generic and work for all future agents",
      "Must preserve orphan detection for truly unused agents"
    ]
  },
  "root_cause_analysis": {
    "symptom": "git-edge-case-analyst.md incorrectly flagged as orphaned",
    "root_cause": "Orphan detection logic too narrow - only checks 'subagent_type' pattern, missing agent references in Step descriptions and Task tool calls",
    "root_cause_commit": "78928f57 - cleanup workflow archived git-edge-case-analyst",
    "why_introduced": "Detection logic designed for agents referenced via subagent_type parameter, didn't account for agents mentioned in prose/steps",
    "why_problematic": "Agents can be invoked multiple ways: (1) subagent_type parameter, (2) Task tool with agent path, (3) Step descriptions, (4) orchestrator.sh calls. Current logic only checks #1.",
    "timeline": "Jan 7: git-edge-case-analyst created → Jan 8 13:20: archived as orphaned due to narrow detection",
    "affected_files": ["agents/cleanliness-inspector.md lines 320-344"]
  },
  "context": {
    "current_detection_logic": "lines 335-337: only checks subagent_type, Task.*agent_name, agents/agent_name.md patterns",
    "missing_patterns": [
      "Invoke/call/delegate in Step descriptions",
      "orchestrator.sh script references",
      "Task tool with description mentioning agent",
      "Agent mentioned in workflow documentation"
    ],
    "test_command_reference": "commands/test.md should have Step 1 mentioning git-edge-case-analyst"
  },
  "development_approach": {
    "strategy": "Enhance detection logic with 4+ grep patterns covering all common agent invocation methods",
    "detection_patterns_to_add": [
      "grep -rqi 'invoke.*$agent_name' commands/",
      "grep -rqi 'call.*$agent_name' commands/",
      "grep -rqi 'delegate.*$agent_name' commands/",
      "grep -rq 'orchestrator.sh.*$agent_name' commands/",
      "grep -rq 'agents/$agent_name' commands/ (already exists, keep)"
    ],
    "files_to_modify": [
      "agents/cleanliness-inspector.md - Enhance Step 8 detection logic",
      "commands/test.md - Add Step 1 explicitly referencing git-edge-case-analyst",
      "git mv to restore git-edge-case-analyst.md"
    ],
    "validation_approach": "QA will verify detection logic has 5+ patterns, test.md references git-edge-case-analyst, and agent is not flagged as orphaned"
  },
  "standards_to_enforce": {
    "no_hardcoded_values": true,
    "generic_detection_logic": true,
    "integer_step_numbering": true,
    "git_root_cause_reference": true
  }
}
