#!/usr/bin/env bash
# Description: Generate INDEX.md for folder (inventory of contents)
# Usage: generate-folder-index.sh <folder_path>
# Exit codes: 0=success, 1=failure

set -euo pipefail

FOLDER_PATH="${1:?Missing folder path}"

# Validate folder exists
if [[ ! -d "$FOLDER_PATH" ]]; then
  echo "Error: Folder not found: $FOLDER_PATH" >&2
  exit 1
fi

FOLDER_NAME=$(basename "$FOLDER_PATH")
INDEX_FILE="${FOLDER_PATH}/INDEX.md"
TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

# Count files and directories
TOTAL_FILES=$(find "$FOLDER_PATH" -type f | wc -l)
TOTAL_DIRS=$(find "$FOLDER_PATH" -mindepth 1 -type d | wc -l)

# Generate INDEX.md
cat > "$INDEX_FILE" <<EOF
# ${FOLDER_NAME} Index

Auto-generated folder inventory. Last updated: ${TIMESTAMP}

## Structure

Total files: ${TOTAL_FILES}
Total subdirectories: ${TOTAL_DIRS}

## Contents

EOF

# List files organized by directory
find "$FOLDER_PATH" -type f | sort | while read -r file; do
  rel_path="${file#$FOLDER_PATH/}"
  echo "- \`${rel_path}\`" >> "$INDEX_FILE"
done

cat >> "$INDEX_FILE" <<'EOF'

---

*This file is auto-generated by rule-inspector. Do not edit manually.*
EOF

echo "Generated: $INDEX_FILE" >&2
exit 0
